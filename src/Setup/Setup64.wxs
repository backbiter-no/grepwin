<?xml version="1.0" encoding="Windows-1252"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <!-- This gets automatically generated by the makefile running SubWCRev.exe on VersionNumberInclude.in.wxi -->
  <?include VersionNumberInclude.wxi ?>
  <Product
    UpgradeCode="C73ED533-953E-47E5-9A42-A48292BB7C6C"
    Name="grepWin x64"
    Id="*"
    Language="1033"
    Codepage="1252"
    Version="$(var.MajorVersion).$(var.MinorVersion).$(var.BuildVersion)"
    Manufacturer="Stefans Tools">

    <Package Id="*"
             Keywords="Installer"
             Description="Stefans grepWin x64"
             Comments="http://tools.stefankueng.com"
             Manufacturer="Stefans Tools"
             InstallerVersion="200"
             Platform="x64"
             Languages="1033"
             Compressed="yes"
             SummaryCodepage="1252" />

    <Upgrade Id="C73ED533-953E-47E5-9A42-A48292BB7C6C" >
      <!-- flag is set if the install will trigger an upgrade of an existing install -->
      <UpgradeVersion Property="PREVIOUSVERSIONSINSTALLED" Maximum="$(var.MajorVersion).$(var.MinorVersion).$(var.BuildVersion)" IncludeMaximum="no" />
    </Upgrade>

    <Media Id="1" Cabinet="grepWin.cab" EmbedCab="yes" CompressionLevel="high" />
    <Icon Id="grepWinIcon" SourceFile="..\Resources\grepWin.ico" />
    <Property Id="ARPPRODUCTICON">grepWinIcon</Property>
    <Condition Message="This application requires an 64-bit OS">VersionNT64</Condition>
    
    <Property Id="ApplicationFolderName" Value="grepWin" />

    <!-- This property sets the default selected value of the radio button 
         on the install scope dialog in the setup UI where the user can choose 
         whether to install the product per-machine or per-user. -->
    <Property Id='WixAppFolder' Value='WixPerUserFolder' />
    <!--Property Id='WixAppFolder' Value='WixPerMachineFolder' /-->

    <Property Id="APPLICATIONFOLDER" Secure="yes">
      <RegistrySearch Id="FindInstallLocation"
                      Root="HKLM"
                      Key="Software\Microsoft\Windows\CurrentVersion\Uninstall\[WIX_UPGRADE_DETECTED]"
                      Name="InstallLocation"
                      Type="raw"
                      Win64="yes" />
    </Property>
    <SetDirectory Id="APPLICATIONFOLDER"
                  Value="[ProgramFiles64Folder][ApplicationFolderName]">APPLICATIONFOLDER=""</SetDirectory>

    <!-- msiexec does not have a manifest, so it always reports the version of system dlls as
         for Win7 (6.3.x.x). So we check for 6.3 but use the build number to actually check
         for Win11 -->
    <Property Id="WIN11FOUND" Secure="yes">
      <DirectorySearch Id="searchSystem" Path="[System64Folder]" AssignToProperty="yes">
        <FileSearch Id="searchFile" Name="shell32.dll" MinVersion="6.3.21999.0"/>
      </DirectorySearch>
    </Property>

    <!-- properties for the custom actions to (un)register the sparse package -->
    <Property Id="SPARSEPACKAGEFILE" Value="package.msix"  Secure="yes"/>
    <Property Id="SPARSEPACKAGENAME" Value="7BE7C3C4-6740-4AB4-9C5B-DD64067515BF"  Secure="yes"/>

    <Binary Id="CustomActions.dll"  SourceFile="../../bin/release/CustomActions.dll" />
    <CustomAction Id="RegisterSparsePackage" BinaryKey="CustomActions.dll" DllEntry="RegisterSparsePackage"/>
    <CustomAction Id="UnregisterSparsePackage" BinaryKey="CustomActions.dll" DllEntry="UnregisterSparsePackage"/>

    <!-- Fix for WixUI_Advanced to set properties correctly -->
    <Property Id='ALLUSERS' Value='2' />
    <Property Id='MSIINSTALLPERUSER' Value='1'/>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder" Name="PFiles">
        <Directory Id="APPLICATIONFOLDER" Name="grepWin">

          <Component Id="MainEXE" Guid="6EB3126A-B40B-43D8-96A7-8C171591E01F" Win64="yes">
            <File Id="grepWin.EXE" Name="grepWin.exe" DiskId="1" Source="../../bin/release64/grepWin.exe" Vital="yes" />
            <File Id="package.msix" Name="package.msix" DiskId="1" Source="../../bin/release64/package.msix" Vital="yes" />
            <File Id="shelldll" Name="ExplorerCommandVerb.dll" DiskId="1" Source="../../bin/release64/ExplorerCommandVerb.dll" Vital="yes" />
            <File Id="German.lang" Name="German.lang" DiskId="1" Source="../../translations/German.lang" />
            <File Id="Chinese.lang" Name="Chinese.lang" DiskId="1" Source="../../translations/Chinese.lang" />
            <File Id="Japanese.lang" Name="Japanese.lang" DiskId="1" Source="../../translations/Japanese.lang" />
            <File Id="Dutch.lang" Name="Dutch.lang" DiskId="1" Source="../../translations/Dutch.lang" />
            <File Id="Polish.lang" Name="Polish.lang" DiskId="1" Source="../../translations/Polish.lang" />
            <File Id="Spanish.lang" Name="Spanish.lang" DiskId="1" Source="../../translations/Spanish.lang" />
            <File Id="Italian.lang" Name="Italian.lang" DiskId="1" Source="../../translations/Italian.lang" />
            <File Id="Portuguese_Brazilian.lang" Name="Portuguese Brazilian.lang" DiskId="1" Source="../../translations/Portuguese Brazilian.lang" />
            <File Id="French.lang" Name="French.lang" DiskId="1" Source="../../translations/French.lang" />
            <File Id="Turkish.lang" Name="Turkish.lang" DiskId="1" Source="../../translations/Turkish.lang" />
            <File Id="Russian.lang" Name="Russian.lang" DiskId="1" Source="../../translations/Russian.lang" />
            <File Id="Greek.lang" Name="Greek.lang" DiskId="1" Source="../../translations/Greek.lang" />
            <File Id="Belarusian.lang" Name="Belarusian.lang" DiskId="1" Source="../../translations/Belarusian.lang" />
            <File Id="Hungarian.lang" Name="Hungarian.lang" DiskId="1" Source="../../translations/Hungarian.lang" />
            <File Id="Portuguese.lang" Name="Portuguese.lang" DiskId="1" Source="../../translations/Portuguese.lang" />
            <File Id="Slovak.lang" Name="Slovak.lang" DiskId="1" Source="../../translations/Slovak.lang" />
            <File Id="Swedish.lang" Name="Swedish.lang" DiskId="1" Source="../../translations/Swedish.lang" />
            <File Id="Afrikaans.lang" Name="Afrikaans.lang" DiskId="1" Source="../../translations/Afrikaans.lang" />
            <File Id="Korean.lang" Name="Korean.lang" DiskId="1" Source="../../translations/Korean.lang" />
            <File Id="Spanish_Mexican.lang" Name="Spanish Mexican.lang" DiskId="1" Source="../../translations/Spanish Mexican.lang" />
            <File Id="Hindi.lang" Name="Hindi.lang" DiskId="1" Source="../../translations/Hindi.lang" />
            <RegistryKey Root="HKMU" Key="Software\Classes\Directory\shell\grepWin" />
            <RegistryValue Root="HKMU" Key="Software\Classes\Directory\shell\grepWin" Value="Search with grepWin" Type="string" />
            <RegistryValue Root="HKMU" Key="Software\Classes\Directory\shell\grepWin\command" Value='"[APPLICATIONFOLDER]grepWin.exe" /searchpath:"%1"' Type="string" />
            <RegistryValue Root="HKMU" Key="Software\Classes\Directory\shell\grepWin" Name="Icon" Value='[APPLICATIONFOLDER]grepWin.exe,-107' Type="string" />
            <RegistryKey Root="HKMU" Key="Software\Classes\Directory\Background\shell\grepWin" />
            <RegistryValue Root="HKMU" Key="Software\Classes\Directory\Background\shell\grepWin" Value="Search with grepWin" Type="string" />
            <RegistryValue Root="HKMU" Key="Software\Classes\Directory\Background\shell\grepWin" Name="Icon" Value='[APPLICATIONFOLDER]grepWin.exe,-107' Type="string" />
            <RegistryValue Root="HKMU" Key="Software\Classes\Directory\Background\shell\grepWin\command" Value='"[APPLICATIONFOLDER]grepWin.exe" /searchpath:"%V"' Type="string" />
            <RegistryKey Root="HKMU" Key="Software\Classes\LibraryFolder\background\shell\grepWin" />
            <RegistryValue Root="HKMU" Key="Software\Classes\LibraryFolder\background\shell\grepWin" Value="Search with grepWin" Type="string" />
            <RegistryValue Root="HKMU" Key="Software\Classes\LibraryFolder\background\shell\grepWin" Name="Icon" Value='[APPLICATIONFOLDER]grepWin.exe,-107' Type="string" />
            <RegistryValue Root="HKMU" Key="Software\Classes\LibraryFolder\background\shell\grepWin\command" Value='"[APPLICATIONFOLDER]grepWin.exe" /searchpath:"%V"' Type="string" />
            <RegistryKey Root="HKMU" Key="Software\Classes\Folder\shell\grepWin" />
            <RegistryValue Root="HKMU" Key="Software\Classes\Folder\shell\grepWin" Value="Search with grepWin" Type="string" />
            <RegistryValue Root="HKMU" Key="Software\Classes\Folder\shell\grepWin" Name="Icon" Value='[APPLICATIONFOLDER]grepWin.exe,-107' Type="string" />
            <RegistryValue Root="HKMU" Key="Software\Classes\Folder\shell\grepWin\command" Value='"[APPLICATIONFOLDER]grepWin.exe" /searchpath:"%1"' Type="string" />
            <RegistryKey Root="HKMU" Key="Software\Classes\Drive\shell\grepWin" />
            <RegistryValue Root="HKMU" Key="Software\Classes\Drive\shell\grepWin" Value="Search with grepWin" Type="string" />
            <RegistryValue Root="HKMU" Key="Software\Classes\Drive\shell\grepWin" Name="Icon" Value='[APPLICATIONFOLDER]grepWin.exe,-107' Type="string" />
            <RegistryValue Root="HKMU" Key="Software\Classes\Drive\shell\grepWin\command" Value='"[APPLICATIONFOLDER]grepWin.exe" /searchpath:"%1"' Type="string" />
            <RegistryKey Root="HKMU" Key="Software\Classes\*\shell\grepWin" />
            <RegistryValue Root="HKMU" Key="Software\Classes\*\shell\grepWin" Value="Search with grepWin" Type="string" />
            <RegistryValue Root="HKMU" Key="Software\Classes\*\shell\grepWin" Name="Icon" Value='[APPLICATIONFOLDER]grepWin.exe,-107' Type="string" />
            <RegistryValue Root="HKMU" Key="Software\Classes\*\shell\grepWin\command" Value='"[APPLICATIONFOLDER]grepWin.exe" /searchpath:"%1"' Type="string" />
            <RegistryValue Root="HKMU" Key="Software\Classes\*\shell\grepWin" Name="MultiSelectModel" Value='Player' Type="string" />
            <RegistryKey Root="HKMU" Key="Software\Microsoft\Windows\CurrentVersion\App Paths\grepWin.exe" />
            <RegistryValue Root="HKMU" Key="Software\Microsoft\Windows\CurrentVersion\App Paths\grepWin.exe" Name="Path" Value="[APPLICATIONFOLDER]" Type="string" />
            <RegistryValue Root="HKMU" Key="Software\Microsoft\Windows\CurrentVersion\App Paths\grepWin.exe" Value="[APPLICATIONFOLDER]grepWin.exe" Type="string" />
            <RegistryValue Root="HKMU" Key="Software\grepWin" Name="APPLICATIONFOLDER" Value='[APPLICATIONFOLDER]' Type="string" />
          </Component>

        </Directory>
        <Directory Id="ProgramMenuFolder" Name="Programs">
          <Directory Id="ProgramMenuDir" Name="grepWin" />
        </Directory>
      </Directory>

    </Directory>
    <DirectoryRef Id="ProgramMenuDir">
      <Component Id="StartMenuShortCut" Guid="83F25E6F-0EE0-4ca8-BF92-FCAD9709037E" Win64="yes">
        <Shortcut Id="startMenugrepWin" Directory="ProgramMenuDir" Name="grepWin" Target="[APPLICATIONFOLDER]grepWin.exe" Description="regular expression search" />
        <RemoveFolder Id="ProgramMenuDir" On="uninstall"/>
        <RegistryValue Root="HKMU" Key="Software\grepWin" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <Feature Id="Complete" Title="grepWin" Description="The complete package."
          Display="expand" Level="1" ConfigurableDirectory="APPLICATIONFOLDER">
      <Feature Id="MainEXE" Title="Program" Description="The main executable." Level="1">
        <ComponentRef Id="MainEXE" />
        <ComponentRef Id="StartMenuShortCut" />
      </Feature>
    </Feature>

    <UIRef Id='WixUI_ErrorProgressText' />
    <UIRef Id="WixUI_Advanced" />
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
    <WixVariable Id="WixUIBannerBmp" Value="Banner.jpg" />
    <WixVariable Id="WixUIDialogBmp" Value="Dialog.jpg" />

    <!-- Workaround Wix Bug: https://github.com/wixtoolset/issues/issues/2165 -->
    <UI>
      <UIRef Id="WixUI_Advanced" />
      <Publish Dialog="InstallDirDlg" Control="Next" Event="DoAction" Value="FindRelatedProducts">1</Publish>
      <Publish Dialog="InstallScopeDlg" Control="Next" Property="MSIINSTALLPERUSER" Value="1" Order="3">WixAppFolder = "WixPerUserFolder"</Publish>
      <Publish Dialog="InstallScopeDlg" Control="Next" Property="MSIINSTALLPERUSER" Value="{}" Order="2">WixAppFolder = "WixPerMachineFolder"</Publish>
      <Publish Dialog="InstallScopeDlg" Control="Next" Event="DoAction" Value="Overwrite_WixSetDefaultPerMachineFolder" Order="3">WixAppFolder = "WixPerMachineFolder"</Publish>
      <Publish Dialog="InstallScopeDlg" Control="Next" Event="DoAction" Value="Overwrite_WixSetDefaultPerUserFolder" Order="3">WixAppFolder = "WixPerUserFolder"</Publish>
    </UI>

    <CustomAction Id="Overwrite_WixSetDefaultPerMachineFolder"
                  Property="WixPerMachineFolder" Value="[ProgramFiles64Folder][ApplicationFolderName]"
                  Execute="immediate" />
    <CustomAction Id="Overwrite_WixSetDefaultPerUserFolder"
                  Property="WixSetDefaultPerUserFolder" Value="[LocalAppDataFolder]\Programs\[ApplicationFolderName]"
                  Execute="immediate" />
    <InstallUISequence>
      <Custom Action="Overwrite_WixSetDefaultPerMachineFolder" After="WixSetDefaultPerMachineFolder" />
    </InstallUISequence>
    <InstallExecuteSequence>
      <Custom Action="Overwrite_WixSetDefaultPerMachineFolder" After="WixSetDefaultPerMachineFolder" />
    </InstallExecuteSequence>

    <SetProperty Id="ARPINSTALLLOCATION" Value="[APPLICATIONFOLDER]" After="CostFinalize" />

    <InstallExecuteSequence>
      <AppSearch Sequence="1"></AppSearch>
      <LaunchConditions After="AppSearch" />
      <RemoveExistingProducts After="InstallValidate"><![CDATA[PREVIOUSVERSIONSINSTALLED]]></RemoveExistingProducts>
      <Custom Action="RegisterSparsePackage" After="InstallFinalize">NOT (REMOVE~="ALL") AND (NOT WIN11FOUND="")</Custom>
      <Custom Action="UnregisterSparsePackage" Before="RemoveFiles">(REMOVE~="ALL") AND (NOT WIN11FOUND="")</Custom>
    </InstallExecuteSequence>

  </Product>
</Wix>
